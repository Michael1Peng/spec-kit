# 模板同步管理 - 核心流程分析

## 特征创建与模板同步流程图

```
[用户操作] → [分支创建] → [目录生成] → [模板复制] → [项目配置] → [代理上下文更新]
     ↓            ↓            ↓            ↓            ↓            ↓
create-new-     自动命名     mkdir创建    cp复制文件   提取配置信息  update-agent-
feature.sh      分支策略     规范目录     模板到目标   解析plan.md   context.sh
@scripts/bash   @common.sh   @common.sh   @bash-cp     @python内嵌   @scripts/bash
     │            │            │            │            │            │
     ▼            ▼            ▼            ▼            ▼            ▼
解析功能描述   git checkout  功能目录     spec-template 技术栈解析   多代理文件
自动编号规则   命名规范     结构创建     .md复制      上下文提取   同步更新

分支创建策略:
用户输入 → 自动编号 → 规范命名 → git分支 → 目录同步 → 模板部署
   ↑                                            ↓        ↑
   │                    回滚机制 ←─────────────┘        │
   └─────────── 错误处理(回退分支) ←──────────────────────┘
```

## 配置文件同步管理流程

```
[Plan文件分析] → [配置提取] → [代理识别] → [文件更新] → [上下文合并]
      │              │           │           │           │
      ▼              ▼           ▼           ▼           ▼
┌──────────────┐ ┌─────────────┐ ┌─────────────┐ ┌──────────────┐ ┌──────────────┐
│ plan.md读取  │→│技术栈解析   │→│代理类型匹配 │→│模板文件更新  │→│手动内容保护  │
│ grep语法提取 │→│Language     │→│CLAUDE.md    │→│sed替换操作   │→│备份恢复机制  │
│ 正则模式匹配 │→│Framework    │→│GEMINI.md    │→│Python处理   │→│时间戳更新   │
└──────────────┘ │Database     │ │copilot.md   │ └──────────────┘ └──────────────┘
                 │Project Type │ │cursor.mdc   │
                 └─────────────┘ └─────────────┘

代理上下文更新机制:
update_agent_file() → 检测现有文件 → 选择更新策略 → 执行更新 → 验证结果
                                   ↓              ↓
                              新建流程        更新流程
                                ↓              ↓
                          模板复制+替换    Python解析+合并
```

## 模板文件复制系统架构

```
Template系统架构
===================

templates/ ──→ 模板源 ──→ 目标位置生成 ──→ 配置文件更新
    │            │           │               │
    ▼            ▼           ▼               ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│spec-template.md │→│specs/$BRANCH/   │→│spec.md          │→│功能规范文档     │
│plan-template.md │→│specs/$BRANCH/   │→│plan.md          │→│实现计划文档     │
│agent-file-      │→│REPO_ROOT/       │→│CLAUDE.md等      │→│代理配置文件     │
│template.md      │ │                 │ │                 │ │                 │
└─────────────────┘ └─────────────────┘ └─────────────────┘ └─────────────────┘

文件复制流程控制:
check_file_exists() → determine_copy_strategy() → execute_copy() → validate_result()
                                  ↓                    ↓
                         新建策略(cp template)    更新策略(merge content)
```

## 函数调用关系图

```
主要函数调用链
================

create-new-feature.sh (入口)
│
├── common.sh::get_repo_root()
├── common.sh::get_current_branch()
├── git rev-parse --show-toplevel
├── mkdir -p "$SPECS_DIR"
├── 自动编号逻辑 (HIGHEST计算)
├── git checkout -b "$BRANCH_NAME"
├── mkdir -p "$FEATURE_DIR"
└── cp "$TEMPLATE" "$SPEC_FILE"

setup-plan.sh (计划设置)
│
├── common.sh::get_feature_paths()
│   ├── get_repo_root()
│   ├── get_current_branch()
│   └── get_feature_dir()
├── common.sh::check_feature_branch()
└── cp "$TEMPLATE" "$IMPL_PLAN"

update-agent-context.sh (代理更新)
│
├── grep 配置提取 (plan.md → 变量)
├── update_agent_file() → 代理文件处理
│   ├── 文件存在检查
│   ├── 模板应用/内容合并
│   │   ├── sed 替换操作
│   │   └── python 内嵌脚本
│   └── 手动内容保护机制
└── case分支 → 多代理支持
```

## 关键变量与数据流

```
数据流转与状态管理
===================

输入参数 → 环境变量 → 计算变量 → 文件操作 → 输出确认
    │          │          │          │          │
    ▼          ▼          ▼          ▼          ▼
用户描述   REPO_ROOT   BRANCH_NAME  目标文件   操作状态
命令参数   CURRENT_    FEATURE_     模板源     JSON/文本
操作标志   BRANCH      NUM         复制目标   错误处理

关键变量传递:
$FEATURE_DESCRIPTION → $BRANCH_NAME → $FEATURE_DIR → $SPEC_FILE
                                    ↘ $IMPL_PLAN   ↘ $NEW_PLAN
                                      ↘ 代理配置文件路径

状态检查点:
1. 分支有效性: check_feature_branch()
2. 文件存在性: [[ -f "$TEMPLATE" ]]
3. 目录创建: mkdir -p "$FEATURE_DIR"
4. 操作成功: cp/sed/python 退出码
```

## 核心实现逻辑抽象

### 模板同步管理实现特点

1. **自动化编号系统**:
   - `create-new-feature.sh:25-37` 实现自增编号
   - 遍历existing目录计算最大编号

2. **规范化分支命名**:
   - `create-new-feature.sh:39-41` 字符串清理与格式化
   - 限制3词长度，连字符分隔

3. **模板文件管控**:
   - 条件复制: `[[ -f "$TEMPLATE" ]] && cp "$TEMPLATE" "$SPEC_FILE"`
   - 回退机制: `|| touch "$SPEC_FILE"`

4. **代理配置同步**:
   - Python内嵌处理复杂文本操作
   - 手动添加内容保护机制
   - 多代理类型支持(Claude/Gemini/Copilot/Cursor)

5. **配置提取策略**:
   - grep正则模式匹配提取plan.md关键信息
   - sed字符串替换处理模板变量
   - 条件判断避免无效更新

### 文件操作模式

- **只读操作**: grep/cat读取配置
- **安全写入**: 临时文件+mv原子操作
- **备份保护**: .bak文件+手动内容标记
- **权限控制**: 脚本执行权限检查
